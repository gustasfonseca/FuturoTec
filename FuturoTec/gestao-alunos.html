<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Alunos - Assistente Técnico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* ===== Reset e Fontes ===== */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
body { background-color:#f8f9fa; color:#343a40; line-height:1.6; }
a { text-decoration:none; color:inherit; }
button { cursor:pointer; }

/* ===== Header ===== */
.header { background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:1rem 0; }
.nav-wrapper { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
.logo img { height:50px; }
.nav-desktop { display:flex; gap:1.5rem; }
.nav-link { font-weight:500; color:#343a40; padding:0.5rem 1rem; border-radius:6px; transition:all 0.3s ease; }
.nav-link:hover, .nav-link.active { background-color:#008080; color:#fff; }
.nav-actions .login-btn { display:inline-flex; align-items:center; gap:0.5rem; background-color:#008080; color:#fff; border:none; padding:0.5rem 1rem; border-radius:6px; font-weight:500; transition:background-color 0.3s ease; }
.nav-actions .login-btn:hover { background-color:#006666; }

/* ===== Main Content ===== */
.main-content { max-width:1200px; margin:2rem auto; padding:0 20px; }
.page-header h1 { font-size:2rem; margin-bottom:0.5rem; }
.page-header p { color:#6c757d; }
.table-card { background-color:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-top:1rem; }

/* ===== Search ===== */
.search-container { margin-bottom: 2rem; position: relative; max-width: 400px; }
.search-container input[type="text"] { width: 100%; padding: 10px 15px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1rem; transition: border-color 0.3s; }
.search-container input[type="text"]:focus { border-color: #008080; outline: none; box-shadow: 0 0 0 0.2rem rgba(0, 128, 128, 0.25); }

/* ===== Table ===== */
table { width:100%; border-collapse:collapse; }
th, td { text-align:left; padding:0.8rem; border-bottom:1px solid #e9ecef; }
th { font-weight:600; color:#6c757d; text-transform:uppercase; font-size:0.9rem; }
tr:hover { background-color:#f1f3f5; }

/* ===== Action Buttons ===== */
.action-buttons button { border:none; background:none; font-size:1.2rem; margin-right:0.8rem; color:#343a40; transition:transform 0.2s ease; }
.action-buttons button:hover { transform:scale(1.2); color:#008080; }

/* ===== Footer ===== */
.footer { text-align:center; padding:1.5rem 0; background-color:#008080; color:#fff; font-size:0.9rem; margin-top:3rem; }

/* ===== Modal ===== */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:400px; display:flex; flex-direction:column; gap:10px; }
.modal-content input { padding:8px; border-radius:6px; border:1px solid #ccc; }
.modal-content button { padding:10px; border:none; border-radius:6px; background:#008080; color:#fff; font-weight:500; cursor:pointer; }
.modal-content button:hover { background:#006666; }
.modal-content .cancel-btn { background:#ccc; color:#000; }

/* ===== Responsivo ===== */
@media(max-width:768px){ .nav-desktop { flex-direction:column; gap:0.5rem; } }
</style>
</head>

<body>

<!-- ===== Header ===== -->
<header class="header">
  <div class="container">
    <div class="nav-wrapper">
      <div class="logo">
        <img src="img/FuturoTecInicial.jpeg" alt="FuturoTEC Logo">
      </div>
      <nav class="nav-desktop student-nav">
        <a href="InicialAssistente.html" class="nav-link">Início</a>
      </nav>
      <div class="nav-actions">
        <a href="PerfilAssistente.html" class="login-btn"><i class="fa-solid fa-user"></i> Meu Perfil</a>
      </div>
    </div>
  </div>
</header>

<!-- ===== Main ===== -->
<main class="main-content">
  <div class="page-header">
    <h1>Alunos que Criaram Conta</h1>
    <p>Veja os alunos cadastrados na plataforma. Digite no campo abaixo para filtrar.</p>
  </div>

  <div class="search-container">
    <input type="text" id="searchBar" placeholder="Pesquisar aluno por nome ou email..." list="studentSuggestions">
    <datalist id="studentSuggestions"></datalist>
  </div>

  <div class="table-card">
    <table id="studentsTable">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Telefone</th>
          <th>Idade</th>
          <th>Curso</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<!-- ===== Footer ===== -->
<footer class="footer">
  <div class="container footer-grid">
    <div class="footer-info">
      <h4>FuturoTEC</h4>
      <p>Projeto de Conclusão de Curso (TCC)</p>
      <p class="school">ETEC Albert Einstein</p>
      <p class="copyright">© 2025 FuturoTEC. Todos os direitos reservados.</p>
      <p class="authors">Desenvolvido por: Nátaly Lima, Gustavo Fonseca, Eduarda Marques, Amanda Silva, Gabrielly Mendes, Uillian Oliveira e Felipe Cardoso.</p>
    </div>
    <div class="footer-links">
      <h4>Links Úteis</h4>
      <ul>
        <li>Termos de Uso</li>
        <li>Política de Privacidade</li>
        <li>Sobre nós</li>
        <li>Contato</li>
      </ul>
    </div>
    <div class="footer-social">
      <h4>Conecte-se</h4>
      <div class="social-icons">
        <span>[Facebook]</span>
        <span>[LinkedIn]</span>
        <span>[Twitter]</span>
      </div>
    </div>
  </div>
</footer>

<!-- ===== Modal (Editar Aluno) ===== -->
<div class="modal" id="modal">
  <div class="modal-content">
    <input type="text" id="nomeInput" placeholder="Nome">
    <input type="email" id="emailInput" placeholder="Email">
    <input type="text" id="telefoneInput" placeholder="Telefone">
    <input type="date" id="idadeInput" placeholder="Data de Nascimento">
    <input type="text" id="cursoInput" placeholder="Curso">
    <button type="button" id="saveBtn">Atualizar</button>
    <button type="button" id="cancelBtn" class="cancel-btn">Cancelar</button>
  </div>
</div>

<!-- ===== Firebase Script ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA8Q9cKB4oVmFM6ilHK_70h8JDvgsOQhLY",
  authDomain: "futurotec-e3a69.firebaseapp.com",
  projectId: "futurotec-e3a69",
  storageBucket: "futurotec-e3a69.appspot.com",
  messagingSenderId: "234233783827",
  appId: "1:234233783827:web:bf9376dee78d8924ef01e6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const alunosRef = collection(db, "usuarios");
const tableBody = document.querySelector("#studentsTable tbody");
const modal = document.getElementById("modal");
const nomeInput = document.getElementById("nomeInput");
const emailInput = document.getElementById("emailInput");
const telefoneInput = document.getElementById("telefoneInput");
const idadeInput = document.getElementById("idadeInput");
const cursoInput = document.getElementById("cursoInput");
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const searchBar = document.getElementById("searchBar");
const studentSuggestions = document.getElementById("studentSuggestions");

let allStudents = [];
let editId = null;
let userIsAssistente = false;

function calcularIdade(dataNascimento){
  if(!dataNascimento) return "";
  const hoje = new Date();
  const nascimento = new Date(dataNascimento);
  let idade = hoje.getFullYear() - nascimento.getFullYear();
  const m = hoje.getMonth() - nascimento.getMonth();
  if(m<0 || (m===0 && hoje.getDate()<nascimento.getDate())) idade--;
  return idade;
}

function renderizarAlunos(alunos){
  tableBody.innerHTML = "";
  if(alunos.length===0){
    const row = tableBody.insertRow();
    const cell = row.insertCell();
    cell.colSpan = 6;
    cell.style.textAlign="center";
    cell.textContent = "Nenhum aluno encontrado.";
    return;
  }
  alunos.forEach(aluno=>{
    const row = tableBody.insertRow();
    row.dataset.id = aluno.id;
    row.innerHTML = `
      <td>${aluno.nome||''}</td>
      <td>${aluno.email||''}</td>
      <td>${aluno.telefone||''}</td>
      <td>${calcularIdade(aluno.dataNascimento)||''}</td>
      <td>${aluno.cursoNome||''}</td>
      <td class="action-buttons">
        <button class="edit-btn" title="Editar"><i class="fa-solid fa-pencil"></i></button>
        <button class="delete-btn" title="Excluir"><i class="fa-solid fa-trash-can"></i></button>
      </td>
    `;
  });
}

async function carregarAlunos(){
  tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Carregando alunos...</td></tr>';
  try{
    const snapshot = await getDocs(alunosRef);
    allStudents = snapshot.docs.map(docSnap=>({id:docSnap.id,...docSnap.data()})).filter(u=>u.role==='aluno');
    renderizarAlunos(allStudents);
    atualizarSugestoes(allStudents);
  }catch(e){
    console.error(e);
    tableBody.innerHTML='<tr><td colspan="6" style="text-align:center;color:red;">Erro ao carregar alunos.</td></tr>';
  }
}

function filtrarAlunos(){
  const termo = searchBar.value.toLowerCase().trim();
  if(!termo){ renderizarAlunos(allStudents); return; }
  const filtered = allStudents.filter(a=> (a.nome&&a.nome.toLowerCase().includes(termo))||(a.email&&a.email.toLowerCase().includes(termo)));
  renderizarAlunos(filtered);
}

function atualizarSugestoes(alunos){
  studentSuggestions.innerHTML='';
  const nomes=new Set();
  alunos.forEach(a=>{if(a.nome) nomes.add(a.nome);});
  nomes.forEach(nome=>{
    const option=document.createElement('option');
    option.value=nome;
    studentSuggestions.appendChild(option);
  });
}

searchBar.addEventListener("input", filtrarAlunos);

tableBody.addEventListener("click", e=>{
  const btn = e.target.closest(".edit-btn,.delete-btn");
  if(!btn) return;
  if(!userIsAssistente){ alert("Você não tem permissão."); return; }

  const row = btn.closest("tr");
  const id = row.dataset.id;
  const aluno = allStudents.find(a=>a.id===id);

  if(btn.classList.contains("edit-btn")){
    nomeInput.value=aluno.nome||'';
    emailInput.value=aluno.email||'';
    telefoneInput.value=aluno.telefone||'';
    idadeInput.value=aluno.dataNascimento||'';
    cursoInput.value=aluno.cursoNome||'';
    editId=id;
    modal.style.display="flex";
  }

  if(btn.classList.contains("delete-btn")){
    if(confirm("Deseja excluir este aluno?")){
      deleteDoc(doc(db,"usuarios",id)).then(()=>{carregarAlunos(); searchBar.value='';}).catch(e=>{console.error(e); alert("Erro ao excluir aluno.");});
    }
  }
});

saveBtn.addEventListener("click", async()=>{
  if(!editId || !userIsAssistente) return;
  try{
    await updateDoc(doc(db,"usuarios",editId),{
      nome:nomeInput.value.trim(),
      email:emailInput.value.trim(),
      telefone:telefoneInput.value.trim(),
      dataNascimento:idadeInput.value.trim(),
      cursoNome:cursoInput.value.trim()
    });
    modal.style.display="none";
    editId=null;
    carregarAlunos();
    searchBar.value='';
  }catch(e){ console.error(e); alert("Erro ao atualizar aluno."); }
});

cancelBtn.addEventListener("click",()=>{modal.style.display="none";});
modal.addEventListener("click",e=>{if(e.target===modal) modal.style.display="none";});

onAuthStateChanged(auth,user=>{
  if(user){
    getDoc(doc(db,"usuarios",user.uid)).then(docSnap=>{
      if(docSnap.exists() && docSnap.data().role==='assistente_tecnico'){
        userIsAssistente=true;
        carregarAlunos();
      }else{
        alert("Acesso negado.");
        window.location.href='InicialAluno.html';
      }
    }).catch(e=>{console.error(e); alert("Erro ao verificar permissão."); window.location.href='Login.html';});
  }else{ alert("Faça login."); window.location.href='Login.html'; }
});
</script>

</body>
</html>
