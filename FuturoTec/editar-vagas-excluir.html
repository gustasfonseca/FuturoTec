<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Vagas - Assistente Técnico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<!-- Verifique se esses caminhos de CSS estão corretos -->
<link rel="stylesheet" href="css/assistente.css">
<link rel="stylesheet" href="css/styles.css">
<style>
  /* Estilos básicos para o modal e para botões desabilitados */
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px; }
  .modal-content input, .modal-content textarea { width: 100%; padding: 8px; box-sizing: border-box; }
  .cancel-btn { background-color: #ccc; }
  .action-buttons button { cursor: pointer; margin-right: 5px; }
  .action-buttons button:disabled { cursor: not-allowed; opacity: 0.5; }

  /* === NOVOS ESTILOS PARA O SELETOR DE CURSOS (TAGS) === */
  /* O container que segura as tags selecionadas */
  .cursos-selecionados-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 8px;
    min-height: 40px;
    background-color: #fff;
  }
  /* A tag individual */
  .curso-tag {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: #0d9488; /* Um tom de verde-azulado (Tailwind Teal 600) */
    color: white;
    padding: 5px 12px;
    border-radius: 20px; /* Arredondado como na imagem */
    font-size: 14px;
    font-weight: 500;
  }
  /* O botão 'X' para remover a tag */
  .remove-tag-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }
  .remove-tag-btn:hover {
    opacity: 0.8;
  }
  /* O wrapper do input de busca e da lista de sugestões */
  .curso-search-wrapper {
    position: relative;
    width: 100%;
  }
  #cursoSearchInput {
      border: 1px solid #ccc;
      border-radius: 8px;
  }
  /* A lista de sugestões que aparece abaixo da busca */
  .sugestoes-dropdown {
    display: none; /* Escondido por padrão */
    position: absolute;
    top: 100%; /* Aparece logo abaixo do input */
    left: 0;
    right: 0;
    background-color: white;
    border: 1px solid #d1d5db; /* Borda cinza */
    border-top: none;
    border-radius: 0 0 8px 8px;
    z-index: 1010; /* Acima do conteúdo do modal */
    max-height: 150px;
    overflow-y: auto;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  /* Um item individual na lista de sugestões */
  .sugestao-item {
    padding: 12px;
    cursor: pointer;
  }
  .sugestao-item:hover {
    background-color: #f3f4f6; /* Cor de fundo suave ao passar o mouse */
  }
  /* === FIM DOS NOVOS ESTILOS === */
</style>
</head>
<body>
<div class="app">
 <!-- ... Seu Header ... -->
 <header class="header">
    <div class="container">
        <div class="nav-wrapper">
            <div class="logo">
                <img src="img/FuturoTecInicial.jpeg" alt="FuturoTEC Logo">
            </div>
            <nav class="nav-desktop">
                <a href="InicialAssistente.html" class="nav-link">Início</a>        
                <a href="editar-vagas-excluir.html" class="nav-link">Gestão das Vagas</a>
                <a href="gestao-alunos.html" class="nav-link">Gestão dos Alunos</a>
            </nav>
            <a href="PerfilAssistente.html" class="login-btn">Meu Perfil</a>
        </div>
    </div>
</header>
<!-- ... Seu Main ... -->
<main class="main-content">
  <div class="page-header">
    <h1>Gestão de Vagas</h1>
    <p>Veja, edite ou exclua as vagas publicadas. Digite no campo abaixo para filtrar.</p>
    <p id="authStatus" style="color: red; font-weight: bold;"></p>
  </div>
  <div class="search-container">
      <input type="text" id="searchBar" placeholder="Pesquisar por título ou local..." list="jobSuggestions">
      <datalist id="jobSuggestions"></datalist>
  </div>
    <div class="table-card">
    <h3>Vagas Publicadas</h3>
    <table id="jobsTable">
      <thead>
        <tr>
          <th>Título</th>
          <th>Local</th>
          <th>Curso Exigido</th>
          <th>Data</th>
          <th>Descrição</th>
          <th>Carga Horária</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="7" style="text-align:center;">Aguardando autenticação...</td></tr></tbody>
    </table>
  </div>
</main>
<!-- ... Seu Footer ... -->
 <footer class="footer">
    <!-- ... (conteúdo do footer omitido por brevidade) ... -->
 </footer>
    
<!-- ================================================== -->
<!-- MODAL COM HTML ATUALIZADO PARA O SELETOR DE CURSOS -->
<!-- ================================================== -->
<div class="modal" id="modal">
  <div class="modal-content">
    <input type="text" id="tituloInput" placeholder="Título da Vaga">
    <input type="text" id="localInput" placeholder="Local">
    
    <!-- NOVO COMPONENTE DE SELEÇÃO DE CURSOS -->
    <label for="cursoSearchInput" style="font-size: 14px; color: #555; margin-bottom: -5px;">Cursos Requeridos</label>
    <!-- 1. O container que vai segurar as tags (pills) -->
    <div id="cursosSelecionadosContainer" class="cursos-selecionados-container">
      <!-- As tags selecionadas aparecerão aqui (ex: [Informática para internet] [X]) -->
    </div>
    <!-- 2. O input de busca com o dropdown de sugestões -->
    <div class="curso-search-wrapper">
      <input type="text" id="cursoSearchInput" placeholder="Busque e selecione o curso...">
      <div id="cursoSugestoes" class="sugestoes-dropdown">
        <!-- As sugestões filtradas aparecerão aqui -->
      </div>
    </div>
    <!-- FIM DO NOVO COMPONENTE -->
    
    <input type="date" id="dataInput" placeholder="Data de Publicação">
    <textarea id="descricaoInput" rows="4" placeholder="Descrição da vaga"></textarea>
    <input type="text" id="cargaInput" placeholder="Carga Horária">
    <button type="button" id="saveBtn">Salvar</button>
    <button type="button" id="cancelBtn" class="cancel-btn">Cancelar</button>
  </div>
</div>

<!-- ====================================================== -->
<!-- SCRIPT ATUALIZADO PARA O SELETOR DE CURSOS -->
<!-- ====================================================== -->
<script type="module">
// Importações do Firebase (Firestore e Auth)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

// Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA8Q9cKB4oVmFM6ilHK_70h8JDvgsOQhLY",
  authDomain: "futurotec-e3a69.firebaseapp.com",
  projectId: "futurotec-e3a69",
  storageBucket: "futurotec-e3a69.appspot.com",
  messagingSenderId: "234233783827",
  appId: "1:234233783827:web:bf9376dee78d8924ef01e6"
};

// Inicializa Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app); 
const vagasRef = collection(db, "vagas");
const cursosRef = collection(db, "cursos"); // NOVA REFERÊNCIA

setLogLevel('debug');

// Elementos do DOM
const tableBody = document.querySelector("#jobsTable tbody");
const modal = document.getElementById("modal");
const inputs = {
  titulo: document.getElementById("tituloInput"),
  local: document.getElementById("localInput"),
  // O 'cursoInput' foi removido daqui
  data: document.getElementById("dataInput"),
  descricao: document.getElementById("descricaoInput"),
  carga: document.getElementById("cargaInput")
};
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");
const searchBar = document.getElementById("searchBar");
const jobSuggestions = document.getElementById("jobSuggestions");
const authStatus = document.getElementById("authStatus");

// NOVOS ELEMENTOS DO DOM PARA AS TAGS DE CURSOS
const cursosSelecionadosContainer = document.getElementById("cursosSelecionadosContainer");
const cursoSearchInput = document.getElementById("cursoSearchInput");
const cursoSugestoes = document.getElementById("cursoSugestoes");

let allJobs = []; 
let editId = null;
let currentUser = null; 

// NOVAS VARIÁVEIS GLOBAIS PARA OS CURSOS
let allCursos = []; // Vai guardar todos os cursos do Firestore (ex: [{id: "1", nome: "Administração"}])
let selectedCursos = []; // Vai guardar os NOMES dos cursos selecionados (ex: ["Administração"])


// --- NOVAS FUNÇÕES PARA O SELETOR DE CURSOS ---

// 1. Busca todos os cursos do Firestore e armazena em 'allCursos'
async function loadCursos() {
  try {
    const snapshot = await getDocs(cursosRef);
    allCursos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    console.log("Cursos carregados:", allCursos);
  } catch (error) {
    console.error("Erro ao carregar cursos:", error);
  }
}

// 2. Renderiza as tags (pills) dentro do container
function renderizarTags() {
  cursosSelecionadosContainer.innerHTML = ""; // Limpa o container
  selectedCursos.forEach(cursoNome => {
    const tag = document.createElement("div");
    tag.className = "curso-tag";
    tag.innerHTML = `
      <span>${cursoNome}</span>
      <button class="remove-tag-btn" data-nome="${cursoNome}">&times;</button>
    `;
    cursosSelecionadosContainer.appendChild(tag);
  });
}

// 3. Renderiza a lista de sugestões filtradas
function renderizarSugestoes(filtro = '') {
  cursoSugestoes.innerHTML = "";
  const filtroLowerCase = filtro.toLowerCase();
  
  // Filtra 'allCursos'
  const cursosFiltrados = allCursos.filter(curso => {
    // 1. O nome do curso deve incluir o filtro
    return curso.nome.toLowerCase().includes(filtroLowerCase) &&
           // 2. O curso NÃO PODE já estar na lista de selecionados
           !selectedCursos.includes(curso.nome);
  });

  if (cursosFiltrados.length > 0 && filtro.length > 0) {
    cursosFiltrados.forEach(curso => {
      const item = document.createElement("div");
      item.className = "sugestao-item";
      item.textContent = curso.nome;
      item.dataset.nome = curso.nome; // Guarda o nome para o clique
      cursoSugestoes.appendChild(item);
    });
    cursoSugestoes.style.display = "block"; // Mostra a lista
  } else {
    cursoSugestoes.style.display = "none"; // Esconde a lista
  }
}

// --- EVENT LISTENERS DO NOVO SELETOR DE CURSOS ---

// Ao digitar no input de busca de curso
cursoSearchInput.addEventListener("input", () => {
  renderizarSugestoes(cursoSearchInput.value);
});

// Ao clicar em um item de sugestão
cursoSugestoes.addEventListener("click", (e) => {
  if (e.target.classList.contains("sugestao-item")) {
    const nomeSelecionado = e.target.dataset.nome;
    selectedCursos.push(nomeSelecionado); // Adiciona ao array
    renderizarTags(); // Re-renderiza as tags
    cursoSearchInput.value = ""; // Limpa o input de busca
    cursoSugestoes.style.display = "none"; // Esconde as sugestões
  }
});

// Ao clicar no 'X' de uma tag (usando delegação de evento)
cursosSelecionadosContainer.addEventListener("click", (e) => {
  if (e.target.classList.contains("remove-tag-btn")) {
    const nomeRemover = e.target.dataset.nome;
    // Remove o curso do array
    selectedCursos = selectedCursos.filter(nome => nome !== nomeRemover);
    renderizarTags(); // Re-renderiza as tags
  }
});

// Esconde as sugestões se clicar fora
document.addEventListener("click", (e) => {
  if (!cursoSearchInput.contains(e.target) && !cursoSugestoes.contains(e.target)) {
    cursoSugestoes.style.display = "none";
  }
});


// --- FUNÇÕES ANTIGAS (COM MODIFICAÇÕES) ---

function formatDate(timestamp) {
    if (!timestamp) return "Não informado";
    const date = timestamp.seconds ? new Date(timestamp.seconds * 1000) : new Date(timestamp);
    return isNaN(date.getTime()) ? "Data inválida" : date.toLocaleDateString('pt-BR');
}

function renderizarVagas(vagas) {
    // ... (função renderizarVagas não muda) ...
    tableBody.innerHTML = "";
    if (vagas.length === 0) { /* ... */ }
    vagas.forEach(v => {
        const localVaga = v.local || "Não informado";
        // ATUALIZADO AQUI: Mostra as tags de curso na tabela também
        const cursosStr = Array.isArray(v.cursosRequeridos) ? v.cursosRequeridos.join(", ") : v.cursosRequeridos || "Não informado";
        const dataPub = formatDate(v.criadaEm);
        const carga = v.cargaHoraria || "Não informado";
        const descricaoCurta = v.descricao ? (v.descricao.length > 50 ? v.descricao.substring(0, 50) + "..." : v.descricao) : '';

        const row = document.createElement("tr");
        row.dataset.id = v.id;
        row.innerHTML = `
            <td>${v.titulo || ''}</td>
            <td>${localVaga}</td>
            <td>${cursosStr}</td>
            <td>${dataPub}</td>
            <td title="${v.descricao || ''}">${descricaoCurta}</td>
            <td>${carga}</td>
            <td class="action-buttons">
                <button class="edit-btn" title="Editar" ${!currentUser ? 'disabled' : ''}><i class="fa-solid fa-pencil"></i></button>
                <button class="delete-btn" title="Excluir" ${!currentUser ? 'disabled' : ''}><i class="fa-solid fa-trash-can"></i></button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

async function carregarVagas() {
    // ... (função carregarVagas não muda) ...
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Carregando vagas...</td></tr>';
    try {
        const snapshot = await getDocs(vagasRef);
        allJobs = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
        if (allJobs.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Nenhuma vaga publicada ainda.</td></tr>';
        } else {
            renderizarVagas(allJobs); 
            atualizarSugestoes(allJobs);
        }
    } catch (error) {
        console.error("Erro ao carregar vagas:", error);
        if (error.code === 'permission-denied') { /* ... */ }
        else { /* ... */ }
    }
}

function filtrarVagas() {
    // ... (função filtrarVagas não muda) ...
    const termo = searchBar.value.toLowerCase().trim();
    if (termo === "") { renderizarVagas(allJobs); return; }
    const filteredJobs = allJobs.filter(vaga =>
        (vaga.titulo && vaga.titulo.toLowerCase().includes(termo)) ||
        (vaga.local && vaga.local.toLowerCase().includes(termo))
    );
    renderizarVagas(filteredJobs);
}

function atualizarSugestoes(vagas) {
    // ... (função atualizarSugestoes não muda) ...
    jobSuggestions.innerHTML = '';
    const sugestoes = new Set();
    vagas.forEach(vaga => { /* ... */ });
    sugestoes.forEach(sugestao => { /* ... */ });
}

// --- EVENT LISTENERS ANTIGOS (COM MODIFICAÇÕES) ---

searchBar.addEventListener("input", filtrarVagas);
cancelBtn.addEventListener("click", () => modal.style.display = "none");
modal.addEventListener("click", e => { if(e.target === modal) modal.style.display = "none"; });

// ATUALIZADO: Ao clicar em "Editar", agora popula o novo seletor de tags
tableBody.addEventListener("click", e => {
  const btn = e.target.closest(".edit-btn, .delete-btn");
  if(!btn || btn.disabled) return; 
  
  const row = btn.closest("tr");
  const id = row.dataset.id;
  const vagaData = allJobs.find(v => v.id === id);
  if (!vagaData) return;

  if(btn.classList.contains("edit-btn")){
    // Preenche os inputs normais
    inputs.titulo.value = vagaData.titulo || '';
    inputs.local.value = vagaData.local || '';
    
    // --- ATUALIZAÇÃO PARA AS TAGS ---
    // 1. Limpa o array de cursos selecionados
    selectedCursos = [];
    // 2. Preenche o array com os cursos da vaga
    if (Array.isArray(vagaData.cursosRequeridos)) {
      selectedCursos = [...vagaData.cursosRequeridos];
    } else if (vagaData.cursosRequeridos) { // Caso seja uma string única
      selectedCursos = [vagaData.cursosRequeridos];
    }
    // 3. Renderiza as tags no modal
    renderizarTags();
    // 4. Limpa o campo de busca
    cursoSearchInput.value = "";
    // --- FIM DA ATUALIZAÇÃO ---

    let dataISO = '';
    if (vagaData.criadaEm) {
        let dateObj = vagaData.criadaEm.seconds ? new Date(vagaData.criadaEm.seconds * 1000) : new Date(vagaData.criadaEm);
        if (!isNaN(dateObj.getTime())) { dataISO = dateObj.toISOString().split('T')[0]; }
    }
    inputs.data.value = dataISO;
    inputs.descricao.value = vagaData.descricao || '';
    inputs.carga.value = vagaData.cargaHoraria || '';
    editId = id;
    modal.style.display = "flex";
  }

  if(btn.classList.contains("delete-btn")){
    // ... (lógica de exclusão não muda) ...
    console.log("Solicitando exclusão da vaga...");
    deleteDoc(doc(db,"vagas",id))
      .then(() => { /* ... */ })
      .catch(error => { console.error("Erro ao excluir vaga:", error); });
  }
});

// ATUALIZADO: Ao "Salvar", envia o array 'selectedCursos'
saveBtn.addEventListener("click", async () => {
  if (!editId) return;
  try {
    const dataString = inputs.data.value;
    const dataAtualizada = {
      titulo: inputs.titulo.value.trim(),
      local: inputs.local.value.trim(),
      
      // --- ATUALIZAÇÃO PARA AS TAGS ---
      // Agora envia o array 'selectedCursos' diretamente
      cursosRequeridos: selectedCursos,
      // --- FIM DA ATUALIZAÇÃO ---
      
      descricao: inputs.descricao.value.trim(),
      cargaHoraria: inputs.carga.value.trim()
    };
    
    // Validação da data
    if (dataString) {
      const dateObj = new Date(dataString + 'T00:00:00');
      if (!isNaN(dateObj.getTime())) {
        dataAtualizada.criadaEm = dateObj;
      } else {
        console.warn("Data inválida ou vazia, não será atualizada.");
      }
    } 
    
    await updateDoc(doc(db, "vagas", editId), dataAtualizada);
    console.log("Vaga atualizada com sucesso!");
    modal.style.display = "none";
    editId = null;
    carregarVagas();
    searchBar.value = '';
  } catch (error) {
    console.error("Erro ao salvar vaga:", error);
  }
});


// ATUALIZADO: PONTO DE ENTRADA (Agora também carrega os cursos)
console.log("Aguardando status de autenticação...");
onAuthStateChanged(auth, async (user) => { // <-- Adicionado 'async'
  if (user) {
    console.log("Usuário autenticado:", user.uid);
    currentUser = user;
    authStatus.textContent = ""; 
    
    // --- ATUALIZAÇÃO ---
    // Carrega os cursos ANTES de carregar as vagas
    await loadCursos();
    // --- FIM DA ATUALIZAÇÃO ---
    
    carregarVagas();
    
  } else {
    console.warn("Nenhum usuário autenticado.");
    currentUser = null;
    authStatus.textContent = "Você não está logado. Faça login para poder editar ou excluir vagas.";
    
    // Tenta carregar os cursos e vagas (para visualização)
    await loadCursos();
    carregarVagas();
  }
});

</script>

</body>
</html>
