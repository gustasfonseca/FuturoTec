<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Vagas - Assistente Técnico</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
body { background-color:#f8f9fa; color:#343a40; line-height:1.6; }
a { text-decoration:none; color:inherit; }
button { cursor:pointer; }
.header { background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:1rem 0; }
.nav-wrapper { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
.logo img { height:50px; }
.nav-desktop { display:flex; gap:1.5rem; }
.nav-link { font-weight:500; color:#343a40; padding:0.5rem 1rem; border-radius:6px; transition:all 0.3s ease; }
.nav-link:hover, .nav-link.active { background-color:#008080; color:#fff; }
.nav-actions .login-btn { display:inline-flex; align-items:center; gap:0.5rem; background-color:#008080; color:#fff; border:none; padding:0.5rem 1rem; border-radius:6px; font-weight:500; transition:background-color 0.3s ease; }
.nav-actions .login-btn:hover { background-color:#006666; }
.main-content { max-width:1200px; margin:2rem auto; padding:0 20px; }
.page-header h1 { font-size:2rem; margin-bottom:0.5rem; }
.page-header p { color:#6c757d; }

/* Estilos para a Barra de Pesquisa */
.search-container {
    margin-bottom: 2rem;
    position: relative;
    max-width: 500px;
}
.search-container input[type="text"] {
    width: 100%;
    padding: 10px 15px;
    border: 1px solid #ced4da;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.3s;
}
.search-container input[type="text"]:focus {
    border-color: #008080;
    outline: none;
    box-shadow: 0 0 0 0.2rem rgba(0, 128, 128, 0.25);
}

.table-card { background-color:#fff; padding:1.5rem; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.05); margin-top:1rem; overflow-x:auto; }
table { width:100%; border-collapse:collapse; min-width:700px; }
th, td { text-align:left; padding:0.8rem; border-bottom:1px solid #e9ecef; }
th { font-weight:600; color:#6c757d; text-transform:uppercase; font-size:0.9rem; }
tr:hover { background-color:#f1f3f5; }
.action-buttons button { border:none; background:none; font-size:1.2rem; margin-right:0.8rem; color:#343a40; transition:transform 0.2s ease; }
.action-buttons button:hover { transform:scale(1.2); color:#008080; }

/* ESTILOS DO NOVO FOOTER */
.footer { text-align:center; padding:1.5rem 0; background-color:#008080; color:#fff; font-size:0.9rem; margin-top:3rem; }
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
.footer-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr; /* Três colunas */
    gap: 30px;
    text-align: left;
    padding-top: 1rem;
}
.footer-info, .footer-links, .footer-social {
    padding: 0 10px;
}
.footer-info h4, .footer-links h4, .footer-social h4 {
    margin-bottom: 10px;
    font-size: 1.1rem;
    font-weight: 600;
}
.footer-info p {
    margin-bottom: 5px;
    font-size: 0.85rem;
}
.footer-links ul {
    list-style: none;
}
.footer-links li {
    margin-bottom: 5px;
    cursor: pointer;
    transition: color 0.2s;
}
.footer-links li:hover {
    color: #f1f3f5;
}
.social-icons {
    display: flex;
    gap: 15px;
    font-size: 1.2rem;
}
.social-icons span {
    cursor: pointer;
    transition: transform 0.2s;
}
.social-icons span:hover {
    transform: scale(1.1);
}
@media (max-width: 768px) {
    .footer-grid {
        grid-template-columns: 1fr; /* Uma coluna em telas menores */
        text-align: center;
    }
    .social-icons {
        justify-content: center;
    }
}
/* FIM DOS ESTILOS DO NOVO FOOTER */

.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:500px; display:flex; flex-direction:column; gap:10px; }
.modal-content input, .modal-content textarea { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; resize:none; }
.modal-content button { padding:10px; border:none; border-radius:6px; background:#008080; color:#fff; font-weight:500; cursor:pointer; }
.modal-content button:hover { background:#006666; }
.modal-content .cancel-btn { background:#ccc; color:#000; }
@media(max-width:768px){ .nav-desktop { flex-direction:column; gap:0.5rem; } }
</style>
</head>
<body>

<header class="header">
  <div class="container">
    <div class="nav-wrapper">
      <div class="logo">
        <img src="img/FuturoTecInicial.jpeg" alt="FuturoTEC Logo">
      </div>
      <nav class="nav-desktop student-nav">
        <a href="InicialAssistente.html" class="nav-link">Início</a>
      </nav>
      <div class="nav-actions">
        <a href="PerfilAssistente.html" class="login-btn"><i class="fa-solid fa-user"></i> Meu Perfil</a>
      </div>
    </div>
  </div>
</header>

<main class="main-content">
  <div class="page-header">
    <h1>Gestão de Vagas</h1>
    <p>Veja, edite ou exclua as vagas publicadas. Digite no campo abaixo para filtrar.</p>
  </div>

  <div class="search-container">
      <input type="text" id="searchBar" placeholder="Pesquisar por título ou local..." list="jobSuggestions">
      <datalist id="jobSuggestions"></datalist>
  </div>
    <div class="table-card">
    <h3>Vagas Publicadas</h3>
    <table id="jobsTable">
      <thead>
        <tr>
          <th>Título</th>
          <th>Local</th>
          <th>Curso Exigido</th>
          <th>Data</th>
          <th>Descrição</th>
          <th>Carga Horária</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<footer class="footer">
    <div class="container footer-grid">
        <div class="footer-info">
            <h4>FuturoTEC</h4>
            <p>Projeto de Conclusão de Curso (TCC)</p>
            <p class="school">ETEC Albert Einstein</p>
            <p class="copyright">© 2025 FuturoTEC. Todos os direitos reservados.</p>
            <p class="authors">Desenvolvido por: Nátaly Lima, Gustavo Fonseca, Eduarda Marques, Amanda Silva, Gabrielly Mendes, Uillian Oliveira e Felipe Cardoso.</p>
        </div>

        <div class="footer-links">
            <h4>Links Úteis</h4>
            <ul>
                <li>Termos de Uso</li>
                <li>Política de Privacidade</li>
                <li>Sobre nós</li>
                <li>Contato</li>
            </ul>
        </div>

        <div class="footer-social">
            <h4>Conecte-se</h4>
            <div class="social-icons">
                <span>[Facebook]</span>
                <span>[LinkedIn]</span>
                <span>[Twitter]</span>
            </div>
        </div>
    </div>
</footer>
<div class="modal" id="modal">
  <div class="modal-content">
    <input type="text" id="tituloInput" placeholder="Título da Vaga">
    <input type="text" id="localInput" placeholder="Local">
    <input type="text" id="cursoInput" placeholder="Curso Exigido">
    <input type="date" id="dataInput" placeholder="Data de Publicação">
    <textarea id="descricaoInput" rows="4" placeholder="Descrição da vaga"></textarea>
    <input type="text" id="cargaInput" placeholder="Carga Horária">
    <button type="button" id="saveBtn">Salvar</button>
    <button type="button" id="cancelBtn" class="cancel-btn">Cancelar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getFirestore, collection, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA8Q9cKB4oVmFM6ilHK_70h8JDvgsOQhLY",
  authDomain: "futurotec-e3a69.firebaseapp.com",
  projectId: "futurotec-e3a69",
  storageBucket: "futurotec-e3a69.appspot.com",
  messagingSenderId: "234233783827",
  appId: "1:234233783827:web:bf9376dee78d8924ef01e6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const vagasRef = collection(db, "vagas");

const tableBody = document.querySelector("#jobsTable tbody");
const modal = document.getElementById("modal");
const inputs = {
  titulo: document.getElementById("tituloInput"),
  local: document.getElementById("localInput"),
  curso: document.getElementById("cursoInput"),
  data: document.getElementById("dataInput"),
  descricao: document.getElementById("descricaoInput"),
  carga: document.getElementById("cargaInput")
};
const saveBtn = document.getElementById("saveBtn");
const cancelBtn = document.getElementById("cancelBtn");

// NOVOS ELEMENTOS E VARIÁVEIS
const searchBar = document.getElementById("searchBar");
const jobSuggestions = document.getElementById("jobSuggestions");
let allJobs = []; // Array para armazenar todas as vagas carregadas
let editId = null;

// Função para formatar a data
function formatDate(timestamp) {
    if (!timestamp) return "Não informado";
    const date = timestamp.seconds 
        ? new Date(timestamp.seconds * 1000) 
        : new Date(timestamp);
    // Verifica se a data é válida antes de formatar
    return isNaN(date) ? "Não informado" : date.toLocaleDateString();
}

// Função para preencher a tabela com uma lista específica de vagas
function renderizarVagas(vagas) {
    tableBody.innerHTML = "";
    if (vagas.length === 0) {
        const row = tableBody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = 7;
        cell.style.textAlign = "center";
        cell.textContent = "Nenhuma vaga encontrada.";
        return;
    }

    vagas.forEach(v => {
        const localVaga = v.local || "Não informado";
        // Assume que cursosRequeridos é um array de strings, se for outro tipo, ajuste aqui.
        const cursosStr = Array.isArray(v.cursosRequeridos) ? v.cursosRequeridos.join(", ") : v.cursosRequeridos || "Não informado";
        const dataPub = formatDate(v.criadaEm);
        const carga = v.cargaHoraria || "Não informado";

        const row = document.createElement("tr");
        row.dataset.id = v.id;
        row.innerHTML = `
            <td>${v.titulo || ''}</td>
            <td>${localVaga}</td>
            <td>${cursosStr}</td>
            <td>${dataPub}</td>
            <td>${v.descricao || ''}</td>
            <td>${carga}</td>
            <td class="action-buttons">
                <button class="edit-btn" title="Editar"><i class="fa-solid fa-pencil"></i></button>
                <button class="delete-btn" title="Excluir"><i class="fa-solid fa-trash-can"></i></button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Carrega vagas do Firebase e armazena
async function carregarVagas() {
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Carregando vagas...</td></tr>';
    try {
        const snapshot = await getDocs(vagasRef);
        // Mapeia os documentos para um array de objetos, incluindo o ID
        allJobs = snapshot.docs.map(docSnap => ({
            id: docSnap.id,
            ...docSnap.data()
        }));

        if (allJobs.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Nenhuma vaga publicada ainda.</td></tr>';
            return;
        }

        renderizarVagas(allJobs); // Renderiza a lista completa
        atualizarSugestoes(allJobs); // Atualiza as sugestões de pesquisa
    } catch (error) {
        console.error("Erro ao carregar vagas:", error);
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Erro ao carregar vagas.</td></tr>';
    }
}

// Filtra a lista de vagas com base no termo de pesquisa
function filtrarVagas() {
    const termo = searchBar.value.toLowerCase().trim();

    if (termo === "") {
        renderizarVagas(allJobs); // Mostra todas se o campo estiver vazio
        return;
    }

    const filteredJobs = allJobs.filter(vaga =>
        (vaga.titulo && vaga.titulo.toLowerCase().includes(termo)) ||
        (vaga.local && vaga.local.toLowerCase().includes(termo))
    );

    renderizarVagas(filteredJobs); // Renderiza a lista filtrada
}

// Adiciona opções de sugestão (datalist)
function atualizarSugestoes(vagas) {
    jobSuggestions.innerHTML = '';
    const sugestoes = new Set(); // Usa Set para garantir unicidade

    vagas.forEach(vaga => {
        if (vaga.titulo) sugestoes.add(vaga.titulo);
        if (vaga.local) sugestoes.add(vaga.local);
    });

    sugestoes.forEach(sugestao => {
        const option = document.createElement('option');
        option.value = sugestao;
        jobSuggestions.appendChild(option);
    });
}

// Evento de digitação na barra de pesquisa
searchBar.addEventListener("input", filtrarVagas);


// Modal e ações
cancelBtn.addEventListener("click", () => modal.style.display = "none");
modal.addEventListener("click", e => { if(e.target === modal) modal.style.display = "none"; });

tableBody.addEventListener("click", e => {
  const btn = e.target.closest(".edit-btn, .delete-btn");
  if(!btn) return;
  const row = btn.closest("tr");
  const id = row.dataset.id;
  // Encontra os dados da vaga no array allJobs
  const vagaData = allJobs.find(v => v.id === id);
  if (!vagaData) return;

  if(btn.classList.contains("edit-btn")){
    inputs.titulo.value = vagaData.titulo || '';
    inputs.local.value = vagaData.local || '';
    // Lida com cursos que podem ser array ou string
    const cursosStr = Array.isArray(vagaData.cursosRequeridos) 
        ? vagaData.cursosRequeridos.join(", ") 
        : vagaData.cursosRequeridos || '';
    inputs.curso.value = cursosStr;

    // Converte timestamp/data para o formato YYYY-MM-DD para o input 'date'
    let dataISO = '';
    if (vagaData.criadaEm) {
        let dateObj;
        if (vagaData.criadaEm.seconds) {
            dateObj = new Date(vagaData.criadaEm.seconds * 1000);
        } else if (vagaData.criadaEm instanceof Date) {
            dateObj = vagaData.criadaEm;
        } else {
            // Tenta criar data a partir de string
            dateObj = new Date(vagaData.criadaEm);
        }

        if (!isNaN(dateObj)) {
             // Formato YYYY-MM-DD
            dataISO = dateObj.toISOString().split('T')[0]; 
        }
    }

    inputs.data.value = dataISO;
    inputs.descricao.value = vagaData.descricao || '';
    inputs.carga.value = vagaData.cargaHoraria || '';
    editId = id;
    modal.style.display = "flex";
  }

  if(btn.classList.contains("delete-btn")){
    if(confirm("Deseja realmente excluir esta vaga?")){
      deleteDoc(doc(db,"vagas",id))
        .then(() => {
            carregarVagas();
            searchBar.value = ''; // Limpa a pesquisa após a exclusão
        })
        .catch(error => {
            console.error("Erro ao excluir vaga:", error);
            alert("Erro ao excluir vaga.");
        });
    }
  }
});

saveBtn.addEventListener("click", async () => {
  if (!editId) return;

  const dataAtualizada = {
    titulo: inputs.titulo.value.trim(),
    local: inputs.local.value.trim(),
    // Converte a string de cursos de volta para um array
    cursosRequeridos: inputs.curso.value.split(",").map(c => c.trim()).filter(c => c.length > 0), 
    criadaEm: new Date(inputs.data.value),
    descricao: inputs.descricao.value.trim(),
    cargaHoraria: inputs.carga.value.trim()
  };

  try {
    await updateDoc(doc(db, "vagas", editId), dataAtualizada);
    modal.style.display = "none";
    editId = null;
    // Recarrega os dados e limpa a pesquisa
    carregarVagas();
    searchBar.value = '';
  } catch (error) {
    console.error("Erro ao salvar vaga:", error);
    alert("Erro ao salvar vaga. Veja o console.");
  }
});

carregarVagas();
</script>

</body>
</html>
