<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Candidaturas | FuturoTEC</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/candidaturas.css" />
    
    <script src="https://unpkg.com/feather-icons"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA8Q9cKB4oVmFM6ilHK_70h8JDvgsOQhLY",
            authDomain: "futurotec-e3a69.firebaseapp.com",
            projectId: "futurotec-e3a69",
            storageBucket: "futurotec-e3a69.firebasestorage.app",
            messagingSenderId: "234233783827",
            appId: "1:234233783827:web:bf9376dee78d8924ef01e6",
            measurementId: "G-C7EEMP1146"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
    
    <script>
        const carregarCandidaturas = async (alunoId) => {
            const candidaturasContainer = document.getElementById('candidaturas-container');
            if (!candidaturasContainer) {
                console.error("Elemento candidaturas-container não encontrado!");
                return;
            }
            
            console.log("Iniciando carregamento de candidaturas para aluno:", alunoId);
            
            try {
                const db = firebase.firestore();
                
                // 1. Primeiro: tentar buscar candidaturas
                console.log("Buscando candidaturas...");
                const candidaturasSnapshot = await db.collection('candidaturas')
                                                    .where('alunoId', '==', alunoId)
                                                    .get();

                console.log("Candidaturas encontradas:", candidaturasSnapshot.size);
                console.log("Documentos:", candidaturasSnapshot.docs);

                if (candidaturasSnapshot.empty) {
                    console.log("Nenhuma candidatura encontrada");
                    candidaturasContainer.innerHTML = '<p class="info-message">Você ainda não se candidatou a nenhuma vaga.</p>';
                    return;
                }

                candidaturasContainer.innerHTML = '';

                // 2. Buscar detalhes das vagas
                console.log("Buscando detalhes das vagas...");
                const promessasVagas = candidaturasSnapshot.docs.map(doc => {
                    const candidaturaData = doc.data();
                    console.log("Dados da candidatura:", candidaturaData);
                    
                    if (!candidaturaData.vagaId) {
                        console.error("Candidatura sem vagaId:", candidaturaData);
                        return null;
                    }
                    
                    console.log("Buscando vaga ID:", candidaturaData.vagaId);
                    return db.collection('vagas').doc(candidaturaData.vagaId).get().then(vagaDoc => {
                        if (vagaDoc.exists) {
                            console.log("Vaga encontrada:", vagaDoc.data());
                            return { 
                                status: candidaturaData.status || 'Pendente', 
                                vaga: vagaDoc.data(),
                                dataCandidatura: candidaturaData.dataCandidatura || candidaturaData.criadaEm
                            };
                        } else {
                            console.error("Vaga não encontrada para ID:", candidaturaData.vagaId);
                            return null;
                        }
                    }).catch(error => {
                        console.error("Erro ao buscar vaga:", error);
                        return null;
                    });
                });

                const resultados = await Promise.all(promessasVagas);
                console.log("Resultados processados:", resultados);

                // 3. Exibir resultados
                resultados.forEach((item, index) => {
                    console.log("Processando item", index, ":", item);
                    if (item && item.vaga) {
                        const vaga = item.vaga;
                        const status = item.status;
                        
                        const card = document.createElement('div');
                        card.className = 'candidatura-card';

                        let statusColorClass = 'status-pending';
                        if (status === 'Aprovado') statusColorClass = 'status-approved';
                        if (status === 'Recusado') statusColorClass = 'status-rejected';
                        
                        // Formatação de data mais robusta
                        let dataFormatada = 'Data não informada';
                        if (item.dataCandidatura) {
                            try {
                                if (item.dataCandidatura.seconds) {
                                    dataFormatada = new Date(item.dataCandidatura.seconds * 1000).toLocaleDateString('pt-BR');
                                } else if (item.dataCandidatura.toDate) {
                                    dataFormatada = item.dataCandidatura.toDate().toLocaleDateString('pt-BR');
                                } else if (item.dataCandidatura instanceof Date) {
                                    dataFormatada = item.dataCandidatura.toLocaleDateString('pt-BR');
                                }
                            } catch (e) {
                                console.error("Erro ao formatar data:", e);
                            }
                        }
                        
                        card.innerHTML = `
                            <div class="candidatura-header">
                                <h3 class="candidatura-titulo">${vaga.titulo || 'Título não informado'}</h3>
                                <span class="candidatura-status ${statusColorClass}">${status}</span>
                            </div>
                            <p class="candidatura-empresa">${vaga.empresa || 'Empresa não informada'}</p>
                            <p class="candidatura-data">Candidatado em: ${dataFormatada}</p>
                        `;
                        candidaturasContainer.appendChild(card);
                    }
                });

                if (candidaturasContainer.children.length === 0) {
                    candidaturasContainer.innerHTML = '<p class="info-message">Nenhuma candidatura válida encontrada.</p>';
                }

            } catch (error) {
                console.error("Erro completo ao buscar candidaturas: ", error);
                console.error("Detalhes do erro:", {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                candidaturasContainer.innerHTML = '<p class="info-message error">Ocorreu um erro ao carregar suas candidaturas. Tente novamente mais tarde.</p>';
            }
        };

        // Verificação de autenticação com mais logs
        firebase.auth().onAuthStateChanged(user => {
            const candidaturasContainer = document.getElementById('candidaturas-container');
            console.log("Estado de autenticação alterado. Usuário:", user);
            
            if (user) {
                console.log("Usuário logado. UID:", user.uid, "Email:", user.email);
                carregarCandidaturas(user.uid);
            } else {
                console.log("Usuário não autenticado. Redirecionando...");
                if (candidaturasContainer) {
                    candidaturasContainer.innerHTML = `
                        <p class="info-message">Você precisa estar logado para ver suas candidaturas.</p>
                        <a href="LoginAluno.html" class="login-btn-center">Fazer Login</a>
                    `;
                }
                window.location.href = 'LoginAluno.html';
            }
        });

        // Teste adicional: verificar se Firebase está carregado
        console.log("Firebase inicializado:", firebase.apps.length > 0);
    </script>
</head>
<body><!-- Header -->
    <header class="header">
        <div class="container">
        <div class="nav-wrapper">
        <div class="logo">
            <img src="img/FuturoTecInicial.jpeg" alt="FuturoTEC Logo">
        </div>
            <nav class="nav-desktop">
              <a href="InicialAluno.html" class="nav-link ">Início</a>
              <a href="#cursos" class="nav-link">Cursos</a>              
              <a href="VagasAluno.html" class="nav-link">Vagas</a>
              <a href="minhasCandidaturas.html" class="nav-link">Candidaturas</a>
            </nav>
            <a href="PerfilAluno.html" class="login-btn">Meu Perfil</a>
      </header>

    <div class="app">

        <main>
            <div class="content-container-colored">
                <div id="candidaturas-container" class="candidaturas-list">
                    <p class="info-message">Carregando suas candidaturas...</p>
                </div>
            </div>
        </main>

        <footer class="footer">
            <!-- Footer content -->
        </footer>
        
        <script>
            feather.replace();
        </script>
    </div>
     <footer class="footer">
    <div class="container footer-grid">
        <div class="footer-info">
            <h4>FuturoTEC</h4>
            <p>Projeto de Conclusão de Curso (TCC)</p>
            <p class="school">ETEC Albert Einstein</p>
            <p class="copyright">© 2025 FuturoTEC. Todos os direitos reservados.</p>
            <p class="authors">Desenvolvido por: Nátaly Lima, Gustavo Fonseca, Eduarda Marques, Amanda Silva, Gabrielly Mendes, Uillian Oliveira e Felipe Cardoso.</p>
        </div>

        <div class="footer-links">
            <h4>Links Úteis</h4>
            <ul>
                <li><a href="#">Termos de Uso</a></li>
                <li><a href="#">Política de Privacidade</a></li>
                <li><a href="#">Sobre nós</a></li>
                <li><a href="#">Contato</a></li>
            </ul>
        </div>


      <div class="container">
                <div class="nav-wrapper">
                    <div class="logo">
                        <img src="img/FuturoTecInicial.jpeg" alt="FuturoTEC Logo" />
                    </div>
                    <br></div>
            <h4>Conecte-se</h4>
            <div class="social-icons">
                <a href="#"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6H6a2 2 0 0 0-2 2z"></path><path d="M14 2v6h6"></path><path d="M8 12h8"></path><path d="M8 16h8"></path></svg></a>
                <a href="#"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a>
                <a href="#"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
            </div>
        </div>
    </div>
    </footer>
</body>
</html>
